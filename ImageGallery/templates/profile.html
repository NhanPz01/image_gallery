<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../static/css/profile.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=VT323&display=swap"
      rel="stylesheet"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>Document</title>
  </head>

  <body>
    <div class="header">
      <a href="{{ url_for('home') }}">
        <div class="logo">
          <h1 class="logo-text logo-text-color-blue">A</h1>
          <h1 class="logo-text logo-text-color-gold">R</h1>
          <h1 class="logo-text logo-text-color-crimson">T</h1>
          <h1 class="logo-text">GALLERY</h1>
        </div>
      </a>

      <div
        style="
          display: flex;
          flex-direction: column;
          justify-self: center;
          align-items: center;
          color: white;
        "
      >
        <h4 style="font-weight: 100">Nguyễn Ngọc Bảo Nhân</h4>
        <h4 style="font-weight: 100">Nguyễn Văn Bách</h4>
        <h4 style="font-weight: 100">Đặng Ngọc Nam</h4>
      </div>
      <div style="display: flex; align-items: center">
        <div style="color: white; text-align: center; margin-right: 20px">
          {{ user.username }}
        </div>
        <div class="navigation">
          <a href="{{ url_for('post') }}" class="nav-button"
            >Share your picture</a
          >
        </div>
        <div class="navigation">
          <a href="{{ url_for('logout') }}" class="logout-button">Logout</a>
        </div>
      </div>
    </div>

    <div
      style="
        display: flex;
        width: vw;
        justify-content: space-between;
        padding: 10px;
      "
    >
      {% for tag in tags %}
      <div class="tag">{{tag.name}}</div>
      {% endfor %}
    </div>
    <h2
      style="
        font-family: VT323;
        text-align: center;
        margin-top: 20px;
        font-size: 30px;
      "
    >
      {{user.username}}'s Gallery
    </h2>
    <div class="container">
      <div class="picture-gallery">
        {% for data in file_data %}
        <div class="picture">
          <img
            src="{{ url_for('uploaded_file', file_id=data.file.id) }}"
            alt="{{ data.file.filename }}"
            data-id="{{ data.file.id }}"
            data-tags="{{ data.tags|join(', ') }}"
            data-username="{{ data.username }}"
            data-upload-time="{{ data.upload_time }}"
            data-title="{{ data.title }}"
          />
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- The Modal -->
    <!-- The Modal -->
    <!-- The Modal -->
    <div id="myModal">
        <span class="close">&times;</span>
        <div class="modal-content">
          <img id="modalImage" src="" alt="Image" />
          <div class="modal-text">
            <p id="modalTags">Tags:</p>
            <p id="modalTitle">Title:</p>
            <p id="modalUsername">Username:</p>
            <p id="modalUploadTime">Upload Time:</p>
            <a id="modalDownloadLink" href="">Download</a>
            <!-- Form to change the image title -->
            <form id="changeTitleForm" method="post">
              <input
                type="text"
                id="newTitle"
                name="newTitle"
                placeholder="New image title"
              />
              <input type="submit" value="Change image title" />
            </form>
            <!-- Form to delete the image -->
            <form id="deleteImageForm" method="post">
              <input type="submit" value="Delete image" />
            </form>
          </div>
        </div>
      </div>

    <script>
      // Function to set up event handlers for the modal
      function setupModalEventHandlers() {
        // Get the modal
        var modal = document.getElementById("myModal");
        var modalContent = document.getElementsByClassName("modal-content")[0];
        // Get the image and insert it inside the modal - use its "alt" text as a caption
        var images = document.getElementsByClassName("picture");
        var modalImg = document.getElementById("modalImage");
        var modalTitle = document.getElementById("modalTitle");
        var modalUsername = document.getElementById("modalUsername");
        var modalUploadTime = document.getElementById("modalUploadTime");
        var modalTags = document.getElementById("modalTags");
        var modalDownloadLink = document.getElementById("modalDownloadLink");
        for (var i = 0; i < images.length; i++) {
          var img = images[i].getElementsByTagName("img")[0];
          img.onclick = function () {
            modal.style.display = "block";
            modalImg.src = this.src;
            modalUsername.innerHTML = "Username: " + this.dataset.username;
            modalUploadTime.innerHTML =
              "Upload Time: " + this.dataset.uploadTime;
            modalTags.innerHTML = "Tags: " + this.dataset.tags;
            modalTitle.innerHTML = "Title: " + this.dataset.title;
            modalDownloadLink.href = this.src;
            modal.style.display = "flex";
          };
        }
        var span = document.getElementsByClassName("close")[0];

        // When the user clicks on <span> (x), close the modal
        span.onclick = function () {
          modal.style.display = "none";
          modalImg.src = "";
          modalTitle.innerHTML = "";
          modalUsername.innerHTML = "";
          modalUploadTime.innerHTML = "";
          modalDownloadLink.href = "";
        };

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function (event) {
          if (event.target == modal) {
            modal.style.display = "none";
            modalImg.src = "";
            modalTitle.innerHTML = "";
            modalUsername.innerHTML = "";
            modalUploadTime.innerHTML = "";
            modalDownloadLink.href = "";
          }
        };
        img.onclick = function () {
          modal.style.display = "block";
          modalImg.src = this.src;
          modalUsername.innerHTML = "Username: " + this.dataset.username;
          modalUploadTime.innerHTML = "Upload Time: " + this.dataset.uploadTime;
          modalTags.innerHTML = "Tags: " + this.dataset.tags;
          modalTitle.innerHTML = "Title: " + this.dataset.title;
          modalDownloadLink.href = this.src;
          modal.style.display = "flex";
          // Set the action URLs for the change name and delete forms
          document.getElementById("changeTitleForm").action =
    "/change_image_title/" + this.dataset.id;
          document.getElementById("deleteImageForm").action =
            "/delete_image/" + this.dataset.id;
        };
      }

      // Call the function to set up the event handlers when the page loads
      setupModalEventHandlers();

      $(document).ready(function () {
        $(".tag").click(function () {
          var tag_name = $(this).text();
          $.get("/tag/" + tag_name, function (data) {
            // Clear the image gallery
            $(".picture-gallery").empty();

            // Add each image to the gallery
            data.forEach(function (image) {
              $(".picture-gallery").append(
                '<div class="picture"><img src="' +
                  image.url +
                  '" alt="' +
                  image.filename +
                  '" data-username="' +
                  image.username +
                  '" data-upload-time="' +
                  image.upload_time +
                  '" /></div>'
              );
            });

            // Set up the event handlers for the new images
            setupModalEventHandlers();
          });
        });
      });
    </script>
  </body>
</html>
